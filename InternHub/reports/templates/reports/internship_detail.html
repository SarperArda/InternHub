{% extends 'base.html' %}
{% load static %}
{% load permissions %}

{% block title %}Internship Detail{% endblock %}

{% block styling %}
    <link rel="stylesheet" type="text/css" href="{% static '' %}">
{% endblock %}

{% block body %}
    <div>
        <h1>Student Report Detail</h1>
        {% if request.user.role != 'STUDENT'%}
            <p>Student Name: {{ internship.student.first_name }} {{ internship.student.last_name}}</p>
            <p>Department of Student: {{ internship.student.department }}</p>
        {% endif %}
        {% if last_submission %}
            <h2>Latest Submission</h2>
            <p>Submission Due Date: {{last_submission.due_date}}</p>
            <p>Submission Status: {{ last_submission.get_status_display }}</p>
            {% if last_submission.file %}
                <p>Submitted File: <a href="{{ last_submission.file.url }}">{{ last_submission.file.name }}</a></p>
                <p>Submitted At: {{ last_submission.creation_date }}</p>
            {% endif %}

            {% if request.user.role == 'STUDENT' and submission_set and last_submission.status == 'PE' and last_submission.due_date > now %}
                <form method="post" enctype="multipart/form-data" action="{% url 'reports:internship_detail' internship.id %}">
                    {% csrf_token %}
                    {{ report_form.as_p }}
                    <button type="submit" name="action" value="submission_upload">Upload</button>
                </form>
            {% endif %}
        {% else %}
            <h2>Your Instructor has not assigned you a submission yet!</h2>
        {% endif %}

        {% if request.user|can_submit_feedback and last_submission.file %}
            <form method="post" action="{% url 'reports:internship_detail' internship.id %}" enctype="multipart/form-data">
                {% csrf_token %}
                <button type="submit" name="action" value="satisfactory">Satisfactory</button>   
                
                {{ form.as_p }}
                {% if form.action.value == 'revision_required' %}
                    <p>Upload Revision File:</p>
                    <input type="file" name="revision_file">
                {% endif %}
                <button type="submit" name="action" value="extend">Change Due Date</button>
                <button type="submit" name="action" value="revision_required">Revision Required</button>  
            </form>
        {% endif %}

        {% if submissions %}
            <h2>Previous Submissions</h2>
            {% for submission in submissions %}
                {% if not forloop.first %}
                    <p>Submitted File: <a href={{ submission.file.url }}>Submission</a></p>
                    <p>Submission Status: {{ submission.get_status_display }}</p>
                    <p>Submitted At: {{ submission.creation_date }}</p>
                    
                    {% if submission.feedback %}
                        <p>Feedback Description: {{ submission.feedback.description }}</p>
                        <p>Received Feedback: <a href={{ submission.feedback.file.url }}>Feedback</a></p>   
                    {% endif %}
                {% endif %}
            {% endfor %}
        {% endif %}


        <a href="{% url 'reports:view_internships' %}">Back to list</a>
    </div>

    
{% endblock %}